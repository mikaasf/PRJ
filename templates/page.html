{% extends 'base.html' %} {% block head %}

<title>Video - Recording</title>
  <script type="text/javascript">

    let counter = 0;
    let socket;
    let isRecording = false;

    var socket = io();

         $(document).ready(function() {

           // sending a connect request to the server.
           
           socket.on('connect', function (){
             socket.emit('my event', {data:"I'm connected"});
           });

           // An event handler for a change of value
           $('button.emoticons').on('click', function (event) {
             if(isRecording){
               socket.emit('emotionButton', {
                 type: $(this).attr('id'),
                 frameID : counter
               });
               return false;
               }
             else{
               alert("You must start recording first");
             }
           });

           // An event handler for a change of value
           $('input.ann').on('keydown', function (event) {
               if (event.key === 'Enter') {
                 if(isRecording) {

                 socket.emit('customInput', {
                   type: $(this).attr('id'),
                   data: $(this).val(),
                   frameID: counter

                 });
               } else {
                  alert("You must start recording first");
                 }
             }

           });

           // An event handler for a change of value
           $('button.stop').on('click', function (event) {
             socket.emit('stop_recording', {
               title: $('input#vid_title').val()
             });
           });

          const videoElem = document.querySelector("#videoElement");
          socket.on("vid", (msg) => {
            // videoElem.src = "data:image/jpg;base64," + Base64.encode(msg.image);
            // console.log(msg.video.length);
            video_src.src = "data:video/mp4;base64," + msg.video;
            videoElem.load();
          });
         });
         
         window.onbeforeunload = function () {
           socket.emit('leaveRecording');
         }
      </script>
{% endblock %}


    // An event handler for a change of value
    $("input.ann").on("keydown", function (event) {
      if (event.key === "Enter") {
        socket.emit("customInput", {
          type: $(this).attr("id"),
          data: $(this).val(),
        });
      }
    });

    const videoElem = document.querySelector("#videoElement");
    socket.on("vid", (msg) => {
      // videoElem.src = "data:image/jpg;base64," + Base64.encode(msg.image);
      // console.log(msg.video.length);
      video_src.src = "data:video/mp4;base64," + msg.video;
      videoElem.load()
    });
  });

</script>
{% endblock %} {% block body %}

<section>
  <section id="video_controls" style="float: left; margin: 0 1.5%; width: 63%">
    <h3>
      <input id="video_title" type="text" name="vid_title" placeholder="Video Title" style="background-color: white; border: none" />
    </h3>
    <span>
      <button id="rec" class="notRec rec-button" disabled></button>
      <button id="changeRec" class="btn-outline-danger" type="submit" onclick="startRecording()">Start Recording</button>
    </span>
    <span class="ml-3" id="timer">00:00:00</span>
    <br/>
    <div class="col-9">
      <!-- <img id="videoElement" src="static/imgs/no_cam.jpg" width="90%" /> -->
      <video id="videoElement" width="90%">
        <source id="video_src" src="">
      </video>
    </div>
    &nbsp;&nbsp; {% include 'annotations.html' %}
{% block body %}


<script type="text/javascript">
  document.getElementById("timer").style.display = "none";

  function startRecording() {
    if (document.getElementById("changeRec").innerHTML === "Stop &amp; save recording") {

      socket.emit("stop_recording", {});

      let form = document.createElement("form");
      form.setAttribute("method", "post");
      let container = document.getElementById("video_controls");
      let elements = [container.childElementCount];
      let j = 0;

      while (container.hasChildNodes()) {
        elements[j] = container.removeChild(container.lastChild);
        j++;
      }

      for (let i = 0; i < elements.length; i++) {
        form.appendChild(elements[i]);
        console.log(elements[i]);
      }
      document.getElementById("video_controls").appendChild(form);

      return;
    }

    document.getElementById("timer").style.display = "inline";
    socket.emit("start_recording", {});
    start();

    let rec_light = document.getElementById("rec");
    let rec_button = document.getElementById("changeRec");
    rec_light.classList.toggle("Rec");
    rec_button.classList.toggle("btn-danger");
    rec_button.classList.toggle("stop");
    document.getElementById("changeRec").innerHTML = "Stop & save recording";
  }

  function timeToString(time) {
    let diffInHours = time / 3600000;
    let hh = Math.floor(diffInHours);

    let diffInMin = (diffInHours - hh) * 60;
    let mm = Math.floor(diffInMin);

    let diffInSec = (diffInMin - mm) * 60;
    let ss = Math.floor(diffInSec);

    let formattedHH = hh.toString().padStart(2, "0");
    let formattedMM = mm.toString().padStart(2, "0");
    let formattedSS = ss.toString().padStart(2, "0");

    return `${formattedHH}:${formattedMM}:${formattedSS}`;
  }

  let startTime;
  let elapsedTime = 0;
  let timerInterval;

  function print(txt) {
    document.getElementById("timer").innerHTML = txt;
  }

  function start() {
    startTime = Date.now() - elapsedTime;
    timerInterval = setInterval(function printTime() {
      elapsedTime = Date.now() - startTime;
      print(timeToString(elapsedTime));
    }, 10);
  }

  function camOff(videoElem) {
    videoElem.src = "static/imgs/no_cam.jpg";
  }

</script>

{% endblock %}
